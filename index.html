<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Coffee Mug — It's a Bug! (AR.js + Hiro)</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }
    #hint {
      position: fixed; top: 10px; left: 10px; right: 10px;
      background: rgba(0,0,0,0.85); color: #fff; padding: 16px;
      border-radius: 14px; font-size: 16px; text-align: center; z-index: 999;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div id="hint">
    Наведи на маркер Hiro → три кружки оживут!<br>
    Тап по экрану — включить безумный танец
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true"
    arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best">

    <a-assets timeout="60000">
      <a-asset-item id="mugModel" src="Coffe-Mug.glb"></a-asset-item>
    </a-assets>

    <a-marker preset="hiro">
      <a-entity id="mugRoot"></a-entity>
    </a-marker>


    <a-entity camera
              position="0 0 2.5"
              rotation="0 0 0"
			  fov="90">
    </a-entity>
  </a-scene>

  <script>
    (function(){
      const mugRoot = document.querySelector('#mugRoot');
      const marker = document.querySelector('a-marker');

      const modelEl = document.createElement('a-entity');
      modelEl.setAttribute('gltf-model', '#mugModel');
      modelEl.setAttribute('scale', '0.6 0.6 0.6');
      mugRoot.appendChild(modelEl);

      let parts = [];
      let animFrame = null;
      let dancing = false;  
      let time = 0;

      modelEl.addEventListener('model-loaded', () => {
        const obj = modelEl.getObject3D('mesh');
        if (!obj) return console.warn('Модель не загрузилась');

        parts = [];
        obj.traverse(node => {
          if (node.isMesh) {
            parts.push(node);
            node.userData.origPos = node.position.clone();


            node.userData.collapsedPos = new THREE.Vector3(0, 0.05, 0);

            const i = parts.length - 1;
            const angle = i / 3 * Math.PI * 2;
            const radius = 0.11;
            node.userData.targetPos = new THREE.Vector3(
              Math.cos(angle) * radius,
              0.05,  
              Math.sin(angle) * radius
            );

            node.position.copy(node.userData.collapsedPos);
          }
        });

        marker.addEventListener('markerFound', () => startTransition(true));
        marker.addEventListener('markerLost', () => startTransition(false));

        mugRoot.sceneEl.addEventListener('click', () => {
          dancing = !dancing;
        });

        let animState = null;

        function startTransition(show) {
          const now = performance.now();
          animState = {
            start: now,
            duration: 800,
            from: parts.map(p => p.position.clone()),
            to: parts.map(p => show ? p.userData.targetPos.clone() : p.userData.collapsedPos.clone())
          };
          if (!animFrame) tick(now);
        }

        function tick(now) {
          time = now * 0.001;  

          if (dancing) {
 
            const spinY = time * 0.8;
            const flipX = Math.sin(time * 1.3) * 0.6;    
            const swayZ = Math.sin(time * 1.7) * 0.3;   
            mugRoot.object3D.rotation.set(flipX, spinY, swayZ);
          }

          if (animState) {
            const t = (now - animState.start) / animState.duration;
            if (t < 1) {
              const e = 1 - Math.pow(1 - t, 3);
              parts.forEach((p, i) => {
                p.position.lerpVectors(animState.from[i], animState.to[i], e);
              });
            } else {
              animState = null;
            }
          }

          animFrame = requestAnimationFrame(tick);
        }

        animFrame = requestAnimationFrame(tick);
      });
    })();
  </script>
</body>
</html>